# OpenAI API Configuration
OPENAI_API_KEY=your_openai_api_key_here

# SQLite
# Optional: override where the SQLite database file lives.
# Useful for production deployments that mount a persistent volume.
# Example: SQLITE_DB_PATH=/app/data/trades.db
# SQLITE_DB_PATH=

# OpenAI API mode
# If true (default), uses the OpenAI Responses API (recommended). Set to "false" to fall back to Chat Completions.
OPENAI_USE_RESPONSES_API=true
# Optional: use the OpenAI Agents SDK for structured outputs and tracing.
# Defaults to true.
OPENAI_USE_AGENTS_SDK=true
# Model to use for trading decisions.
OPENAI_TRADING_MODEL=gpt-5.2

# Bot prompting + caching
# Used to bust caches and track prompt changes.
BOT_PROMPT_VERSION=v1
# If true (default), analyses are cached per (pair,timeframe,candle,positions,variables,prompt).
BOT_ANALYSIS_CACHE_ENABLED=true

# Trade-close reflections (memory)
# If true (default), the server generates a reflection when a BOT trade closes and stores it in SQLite.
BOT_REFLECTIONS_ENABLED=true
# How long to keep reflections (days).
BOT_REFLECTION_RETENTION_DAYS=365

# Bot tuning (minimal, safe-by-default)
# If true (default), periodically tunes the execution minConfidence threshold based on recent BOT trade outcomes.
BOT_TUNING_ENABLED=true
# How often to run the tuner.
BOT_TUNING_INTERVAL_SEC=3600
# How far back to look when tuning.
BOT_TUNING_LOOKBACK_DAYS=30
# Minimum closed BOT trades required to consider updating thresholds.
BOT_TUNING_MIN_TRADES=20

# Evaluation (markouts / decision outcomes)
# If true (default), periodically computes forward-return markouts for bot decisions using market_state_history.
BOT_EVAL_OUTCOMES_ENABLED=true
# How often to run the evaluator.
BOT_EVAL_OUTCOMES_INTERVAL_SEC=300
# How far back to consider decisions for backfill.
BOT_EVAL_OUTCOMES_LOOKBACK_DAYS=30
# Comma-separated horizons in seconds (e.g. 1h, 4h, 24h).
BOT_EVAL_OUTCOMES_HORIZONS_SEC=3600,14400,86400

# ====================
# DB retention + maintenance (storage control)
# ====================
# The largest driver of DB growth is `market_state_history` (append-only) plus bot decision logs.
# These knobs bound growth without impacting live trading (which uses `market_state`).

# Enable background pruning + WAL checkpoint/optimize.
DB_MAINTENANCE_ENABLED=true
# How often to run pruning/maintenance.
DB_MAINTENANCE_INTERVAL_SEC=3600
# Batched deletes reduce long locks + WAL spikes.
DB_DELETE_BATCH_SIZE=10000

# Retention windows (days). Defaults are chosen to preserve tuning/eval lookbacks.
MARKET_STATE_HISTORY_RETENTION_DAYS=45
BOT_DECISIONS_RETENTION_DAYS=45
BOT_UNIVERSE_DECISIONS_RETENTION_DAYS=30
DECISION_OUTCOMES_RETENTION_DAYS=60
METRICS_EVENTS_RETENTION_DAYS=14
MARKET_SNAPSHOTS_RETENTION_DAYS=7

# SQLite maintenance
# Recommended journal mode for write-heavy workloads.
DB_JOURNAL_MODE=WAL
# WAL checkpoint mode: PASSIVE | FULL | RESTART | TRUNCATE
DB_WAL_CHECKPOINT_MODE=TRUNCATE
# Best-effort planner/index optimization.
DB_OPTIMIZE_ENABLED=true

# Vacuum is optional and can be disruptive; leave off unless you need to reclaim file size.
DB_VACUUM_ENABLED=false
# Run vacuum at most once per interval.
DB_VACUUM_INTERVAL_HOURS=168
# If >0, runs `PRAGMA incremental_vacuum(N)` instead of full VACUUM.
DB_INCREMENTAL_VACUUM_PAGES=0

# Bot Safety Settings
BOT_MAX_COLLATERAL=5000
BOT_MAX_LEVERAGE=20
BOT_DAILY_LOSS_LIMIT=1000
# Optional: minimum reward/risk ratio when BOTH stop loss and take profit are provided.
# Set to 0 to disable (default).
BOT_MIN_RISK_REWARD=0

# Bot guardrails (server-enforced)
# Prevent accidental over-trading and stale executions.
BOT_MAX_OPEN_POSITIONS=5
BOT_ALLOW_MULTIPLE_POSITIONS_PER_PAIR=false
# Require a minimum confidence score from the model before execution.
# Confidence is a 0..1 float (e.g., 0.72).
BOT_MIN_CONFIDENCE=0.7
# If true, bot trades will auto-close when price hits stop_loss_price or take_profit_price.
# Set to "false" to disable TP/SL trigger handling for bot positions.
BOT_TP_SL_TRIGGERS_ENABLED=true
# How many analyses to run in parallel during `/api/bot/run`.
BOT_ANALYSIS_CONCURRENCY=2
# Refuse to execute bot decisions older than this.
BOT_MAX_DECISION_AGE_SEC=600
# Refuse to execute if market_state is older than this (defaults to ~2x timeframe).
# BOT_MAX_MARKET_STATE_AGE_SEC=1800
# Refuse to execute if trading variables are older than this.
# BOT_MAX_TRADING_VARIABLES_AGE_SEC=300
#
# Optional: override execution filters (otherwise inherits MARKET_* defaults).
# BOT_MIN_OI_TOTAL=1
# BOT_MAX_COST_PERCENT=0.25

# ====================
# Autotrade worker (optional)
# ====================
# Controlled from the UI (Manual vs Autotrade). The backend scans stored market_state
# frequently, and only calls OpenAI when an opportunity score crosses a threshold.
# Autotrade can hold multiple simultaneous bot positions up to BOT_MAX_OPEN_POSITIONS.
# When both an entry candidate and open bot positions exist, it alternates between
# opening a new position and managing an existing one; when at max, it only manages.
# How often to scan opportunities (cheap; no OpenAI calls unless thresholds pass).
BOT_AUTOTRADE_INTERVAL_SEC=15
# Minimum rank score (0..100) required before calling OpenAI.
BOT_AUTOTRADE_MIN_SCORE=70
# Minimum time between OpenAI calls (hard cap) even if scans are frequent.
BOT_AUTOTRADE_MIN_LLM_INTERVAL_SEC=300
# Entry timeframe (minutes) for ranking + analysis.
BOT_AUTOTRADE_TIMEFRAME_MIN=15
# Regime timeframe (minutes) used as a conservative filter (defaults to 60m).
BOT_AUTOTRADE_REGIME_TIMEFRAME_MIN=60
# Candle lookback windows used for analysis/regime checks (seconds).
BOT_AUTOTRADE_LOOKBACK_SEC=604800
BOT_AUTOTRADE_REGIME_LOOKBACK_SEC=1209600

# Optional: estimated analysis cost in USD per 1K tokens (set based on your model pricing).
# If unset, the UI will display token usage but "N/A" for cost.
BOT_COST_PER_1K_TOKENS_USD=0.01575
BOT_COST_PROMPT_PER_1K_TOKENS_USD=0.00175
BOT_COST_COMPLETION_PER_1K_TOKENS_USD=0.014

# Gains backend data sources
# Used to pull trading variables (fees, spreads, OI, funding/borrowing params) for the AI context.
GAINS_TRADING_VARIABLES_URL=https://backend-base.gains.trade/trading-variables
GAINS_TRADING_VARIABLES_CACHE_MS=60000
# Optional: pick which collateral's OI/fees to include (defaults to first active).
# GAINS_COLLATERAL_SYMBOL=USDC

# Gains pricing websocket (25ms price updates)
# Used by `/api/prices/stream` to proxy realtime prices via SSE to the UI.
GAINS_PRICE_STREAM_WS_URL=wss://backend-pricing.eu.gains.trade

# ====================
# Market data capture (all pairs) + universe ranking
# ====================
# If true, the server connects to the Gains price feed, backfills candles for all pairs,
# computes indicators, and stores the latest state in SQLite for fast cross-asset ranking.
MARKET_DATA_ENABLED=true
# Controls whether we store `market_state_history` (append-only). Live ranking/trading uses `market_state`.
MARKET_STATE_HISTORY_ENABLED=true
# Optional: limit history storage to specific timeframes (comma-separated minutes). Blank = all timeframes.
# Example: MARKET_STATE_HISTORY_TIMEFRAMES_MINUTES=15,60
# MARKET_STATE_HISTORY_TIMEFRAMES_MINUTES=
# Candle timeframes (minutes) to store.
# Tip: include 60/240 if you want 1h/4h leaderboard scores populated in `market_state`.
MARKET_TIMEFRAMES_MINUTES=1,5,15,60,240,1440
# How many candles to backfill per pair/timeframe on startup (must be >= 60; default 250).
MARKET_BACKFILL_CANDLES=250
# Parallelism for backfill HTTP requests.
MARKET_BACKFILL_CONCURRENCY=6
# How often to refresh Gains trading variables (fees/OI/funding) in ms.
MARKET_TRADING_VARIABLES_REFRESH_MS=60000

# Ranking filters (used by /api/market/opportunities and universe scan)
# Minimum total open interest (oi_long + oi_short) to consider a market.
MARKET_MIN_OI_TOTAL=1
# Approx max total cost% (spread + fees) before heavier penalties.
MARKET_MAX_COST_PERCENT=0.25
